@model IEnumerable<SistemaVotoModelos.DTOs.JuntaDetalleDto>

@{
    ViewData["Title"] = "Verificar Juntas";

    var elecciones = ViewBag.Elecciones as List<SistemaVotoModelos.Eleccion>
                     ?? new List<SistemaVotoModelos.Eleccion>();

    int eleccionId = ViewBag.EleccionId != null ? (int)ViewBag.EleccionId : 0;
    var eleccion = elecciones.FirstOrDefault(e => e.Id == eleccionId);
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="fw-bold mb-0">Verificación de Juntas</h3>
        <small class="text-muted">
            Valide la concordancia entre asistencia y sufragios digitales antes de aprobar.
        </small>

        @if (eleccion != null)
        {
            <div class="mt-1">
                <span class="fw-semibold">Elección:</span>
                <span>@eleccion.Titulo</span>
                <span class="ms-2 badge @(eleccion.Estado == "ACTIVA" ? "bg-success" : eleccion.Estado == "FINALIZADA" ? "bg-secondary" : "bg-warning text-dark")">
                    @eleccion.Estado
                </span>
            </div>
        }
    </div>

    <a asp-controller="Admin" asp-action="GestionJuntas" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Volver a Main
    </a>
</div>

<form asp-controller="Admin" asp-action="VerificarJuntas" method="get" class="card shadow-sm border-0 mb-3">
    <div class="card-body d-flex gap-3 align-items-end flex-wrap">
        <div style="min-width:320px;">
            <label class="fw-semibold mb-1">Seleccionar elección</label>
            <select name="eleccionId" class="form-select" required>
                @foreach (var e in elecciones)
                {
                    <option value="@e.Id" selected="@(e.Id==eleccionId)">
                        #@e.Id - @e.Titulo (@e.Estado)
                    </option>
                }
            </select>
        </div>
        <button type="submit" class="btn btn-dark">
            <i class="bi bi-funnel"></i> Filtrar
        </button>
    </div>
</form>

@if (TempData["Mensaje"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        @TempData["Mensaje"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Mesa</th>
                        <th>Ubicación</th>
                        <th class="text-center">Total Votantes</th>
                        <th class="text-center">Asistieron</th>
                        <th class="text-center">Ausentes</th>
                        <th class="text-center bg-primary bg-opacity-10 text-primary">Votos Digitales</th>
                        <th>Estado</th>
                        <th class="text-center">Validación</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model == null || !Model.Any())
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">No hay juntas para esta elección.</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var j in Model)
                        {
                            // Alerta de discrepancia si la asistencia no coincide con los votos reales
                            bool hayDiscrepancia = j.Votaron != j.VotosDigitales;

                            <tr>
                                <td><span class="fw-bold">#@j.NumeroMesa</span></td>
                                <td><small>@j.Ubicacion</small></td>
                                <td class="text-center">@j.TotalVotantes</td>
                                <td class="text-center text-success fw-bold">@j.Votaron</td>
                                <td class="text-center text-muted">@j.NoVotaron</td>
                                <td class="text-center bg-light fw-bold @(hayDiscrepancia ? "text-danger" : "text-primary")">
                                    @j.VotosDigitales
                                    @if (hayDiscrepancia)
                                    {
                                        <i class="bi bi-exclamation-triangle-fill" title="Discrepancia detectada"></i>
                                    }
                                </td>
                                <td>
                                    @switch (j.EstadoJunta)
                                    {
                                        case 1:
                                            <span class="badge bg-secondary">Cerrada</span>
                                            ; break;
                                        case 2:

                                            <span class="badge bg-success">En votación</span>
                                            ; break;
                                        case 3:

                                            <span class="badge bg-warning text-dark">En espera</span>
                                            ; break;
                                        case 4:

                                            <span class="badge bg-primary">Aprobada</span>
                                            ; break;
                                        default:

                                            <span class="badge bg-light text-dark">@j.EstadoJunta</span>
                                            ; break;
                                    }
                                </td>
                                <td class="text-center">
                                    @if (j.EstadoJunta == 3)
                                    {
                                        <form asp-controller="Admin" asp-action="AprobarJuntaVerificada" method="post"
                                              onsubmit="return confirm('¿Confirmas que el acta física coincide con los votos digitales?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@j.Id" />
                                            <input type="hidden" name="eleccionId" value="@eleccionId" />
                                            <button type="submit" class="btn btn-sm btn-outline-success">Validar y aprobar</button>
                                        </form>
                                    }
                                    else if (j.EstadoJunta == 4)
                                    {
                                        <span class="text-primary fw-bold"><i class="bi bi-check-all"></i> Validada</span>
                                    }
                                    else
                                    {
                                        <small class="text-muted">Sin acciones</small>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>