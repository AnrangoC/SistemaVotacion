@{
    ViewData["Title"] = "Resultados de Elecciones";

    var elecciones = ViewBag.Elecciones as List<SistemaVotoModelos.Eleccion>
                     ?? new List<SistemaVotoModelos.Eleccion>();

    int eleccionId = 0;

    if (ViewBag.EleccionSeleccionada != null)
    {
        int.TryParse(ViewBag.EleccionSeleccionada.ToString(), out eleccionId);
    }

    if (eleccionId == 0 && elecciones.Any())
    {
        eleccionId = elecciones
            .OrderByDescending(e => e.FechaInicio)
            .Select(e => e.Id)
            .FirstOrDefault();
    }

    var eleccion = elecciones.FirstOrDefault(e => e.Id == eleccionId);
}

<div class="container mt-4">

    <div class="text-center mb-4">
        <h1 class="fw-bold text-primary">Resultados por Cargo</h1>
        <p class="text-muted">Resultados basados en juntas aprobadas</p>
    </div>

    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-10">
                    <label class="small fw-bold">Elección</label>
                    <select id="inEleccion" class="form-select">
                        @foreach (var e in elecciones.OrderByDescending(x => x.FechaInicio))
                        {
                            <option value="@e.Id" selected="@(e.Id == eleccionId)">
                                #@e.Id - @e.Titulo (@e.Estado)
                            </option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-dark w-100" type="button" onclick="actualizarResultados(true)">
                        Cargar
                    </button>
                </div>
            </div>

            @if (eleccion != null)
            {
                <div class="mt-2 small text-muted">
                    <span class="fw-semibold">Elección actual:</span>
                    <span>@eleccion.Titulo</span>
                    <span class="ms-2 badge @(eleccion.Estado == "ACTIVA" ? "bg-success" : eleccion.Estado == "FINALIZADA" ? "bg-secondary" : "bg-warning text-dark")">
                        @eleccion.Estado
                    </span>
                </div>
            }
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body">
            <div class="row g-2">

                <div class="col-md-4">
                    <label class="small fw-bold">Provincia</label>
                    <input type="text" id="inProvincia" class="form-control">
                </div>

                <div class="col-md-3">
                    <label class="small fw-bold">Cantón</label>
                    <input type="text" id="inCanton" class="form-control">
                </div>

                <div class="col-md-3">
                    <label class="small fw-bold">Parroquia</label>
                    <input type="text" id="inParroquia" class="form-control">
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" type="button" onclick="actualizarResultados()">
                        Consultar
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div id="contenedorRoles"></div>

</div>

@section Scripts {

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>

        let graficos = {};

        document.addEventListener("DOMContentLoaded", () => {
            actualizarResultados(true);
        });

        async function actualizarResultados(esGeneral = false) {

            const prov = document.getElementById('inProvincia').value;
            const cant = document.getElementById('inCanton').value;
            const parr = document.getElementById('inParroquia').value;

            const eleccionId = document.getElementById('inEleccion').value;

            if (!eleccionId) {
                document.getElementById("contenedorRoles").innerHTML =
                    `<div class="alert alert-warning text-center">No hay elecciones para consultar.</div>`;
                return;
            }

            if (!esGeneral && !prov) {
                alert("Debes ingresar al menos la provincia.");
                return;
            }

            const url = `/Resultados/ObtenerJson?eleccionId=${encodeURIComponent(eleccionId)}&provincia=${encodeURIComponent(prov)}&canton=${encodeURIComponent(cant)}&parroquia=${encodeURIComponent(parr)}`;

            try {

                const resp = await fetch(url);
                if (!resp.ok) throw new Error();

                const data = await resp.json();

                renderizarResultados(data);

            } catch {

                document.getElementById("contenedorRoles").innerHTML =
                    `<div class="alert alert-warning text-center">
                        No se encontraron datos.
                    </div>`;
            }
        }

        function renderizarResultados(data) {

            const contenedor = document.getElementById("contenedorRoles");
            contenedor.innerHTML = "";

            if (!data.roles || data.roles.length === 0) return;

            data.roles.forEach((rol, index) => {

                const canvasId = "chart_" + index;

                let html = `
                <div class="card shadow-sm border-0 mb-4 p-3">

                    <h4 class="fw-bold text-center text-primary mb-3">
                        ${rol.rol}
                    </h4>

                    <div style="height:300px">
                        <canvas id="${canvasId}"></canvas>
                    </div>

                    <div class="mt-3">
                `;

                rol.detalle.forEach(item => {

                    const esBlanco = item.nombreLista &&
                                     item.nombreLista.trim().toLowerCase() === "blanco";

                    html += `
                    <div class="mb-2">

                        <div class="d-flex align-items-center mb-1">

                            ${
                                !esBlanco
                                ? `<img src="${
                                        (item.logo && item.logo.trim() !== '')
                                            ? item.logo
                                            : '/img/voto-default.png'
                                    }"
                                    style="width:35px;height:35px;object-fit:contain;background:#fff"
                                    class="me-2 border rounded">`
                                : ''
                            }

                            <span class="fw-bold small">
                                ${item.nombreLista}
                            </span>

                            <span class="ms-auto fw-bold text-primary">
                                ${item.porcentaje}%
                            </span>

                        </div>

                        <div class="progress" style="height:10px">
                            <div class="progress-bar"
                                 style="width:${item.porcentaje}%"></div>
                        </div>

                        <div class="text-end small text-muted">
                            ${item.votos} votos
                        </div>

                    </div>
                    `;
                });

                html += `
                    </div>
                </div>
                `;

                contenedor.insertAdjacentHTML("beforeend", html);
            });

            setTimeout(() => {
                data.roles.forEach((rol, index) => {
                    crearGrafico("chart_" + index, rol);
                });
            }, 50);
        }

        function crearGrafico(canvasId, rol) {

            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext("2d");

            if (graficos[canvasId]) graficos[canvasId].destroy();

            graficos[canvasId] = new Chart(ctx, {

                type: "doughnut",

                data: {
                    labels: rol.detalle.map(x => x.nombreLista),
                    datasets: [{
                        data: rol.detalle.map(x => x.votos),
                        backgroundColor: [
                            "#0d6efd",
                            "#dc3545",
                            "#ffc107",
                            "#198754",
                            "#0dcaf0",
                            "#6610f2"
                        ]
                    }]
                },

                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: "bottom" }
                    }
                }

            });
        }

    </script>
}