@{
    ViewData["Title"] = "Resultados de Elecciones";
}

<div class="container mt-4">
    <div class="text-center mb-4">
        <h1><i class="bi bi-bar-chart-fill text-primary"></i> Conteo de Votos Oficial</h1>
        <p class="text-muted">Resultados en tiempo real basados en juntas validadas.</p>
    </div>

    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="small fw-bold">Provincia</label>
                    <input type="text" id="inProvincia" class="form-control" placeholder="Ej: Guayas">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">Cantón</label>
                    <input type="text" id="inCanton" class="form-control" placeholder="Opcional">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">Parroquia</label>
                    <input type="text" id="inParroquia" class="form-control" placeholder="Opcional">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="actualizarResultados()">
                        <i class="bi bi-search"></i> Consultar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-5 mb-4">
            <div class="card h-100 border-0 shadow-sm p-3">
                <h5 class="text-center fw-bold mb-3">Distribución de Sufragios</h5>
                <div style="position: relative; height:300px;">
                    <canvas id="canvasGrafico"></canvas>
                </div>
                <div id="total-votos-div" class="text-center mt-3 fw-bold text-primary"></div>
            </div>
        </div>

        <div class="col-lg-7">
            <div id="contenedor-barras" class="row">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let graficoVotos; 
        // Al cargar la página, se ejecutan los resultados generales por defecto
        document.addEventListener("DOMContentLoaded", () => {
            actualizarResultados(true);
        });

        async function actualizarResultados(esGeneral = false) {
            const prov = document.getElementById('inProvincia').value;
            const cant = document.getElementById('inCanton').value;
            const parr = document.getElementById('inParroquia').value;
            if (!esGeneral && !prov) {
                alert("Debes ingresar al menos la provincia.");
                return;
            }
            const url = `/Resultados/ObtenerJson?provincia=${prov}&canton=${cant}&parroquia=${parr}`;

            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error("Sin datos");

                const data = await resp.json();
                renderizarPantalla(data);
            } catch (error) {
                document.getElementById('contenedor-barras').innerHTML =
                    '<div class="alert alert-warning text-center">No se encontraron datos validados para esta selección.</div>';
            }
        }

        function renderizarPantalla(data) {
            const barrasDiv = document.getElementById('contenedor-barras');
            const totalDiv = document.getElementById('total-votos-div');
            barrasDiv.innerHTML = "";

            const totalVotos = data.totalVotosGlobal || data.totalVotosEnSector || 0;
            totalDiv.innerText = `Total Votos Contabilizados: ${totalVotos}`;

            if (data.detalle && data.detalle.length > 0) {
                const etiquetas = [];
                const valores = [];

                data.detalle.forEach(item => {
                    etiquetas.push(item.nombreLista);
                    valores.push(item.votos);

                    // Llenar las barras de progreso a la derecha
                    barrasDiv.innerHTML += `
                        <div class="col-12 mb-3">
                            <div class="card border-0 shadow-sm p-2">
                                <div class="d-flex align-items-center mb-1">
                                       <img src="${item.logo || '/img/voto-default.png'}"
                                         style="width:35px; height:35px; object-fit: contain; background-color: #fff;"
                                         class="me-2 rounded border shadow-sm">
                                    <span class="small fw-bold">${item.nombreLista}</span>
                                    <span class="ms-auto fw-bold text-primary">${item.porcentaje}%</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar" style="width: ${item.porcentaje}%"></div>
                                </div>
                                <div class="text-end small text-muted">${item.votos} votos</div>
                            </div>
                        </div>`;
                });

                actualizarDibujoGrafico(etiquetas, valores);
            }
        }

        function actualizarDibujoGrafico(etiquetas, valores) {
            const ctx = document.getElementById('canvasGrafico').getContext('2d');

            // Si el gráfico ya existe, lo destruimos para crear uno nuevo con los nuevos datos
            if (graficoVotos) {
                graficoVotos.destroy();
            }

            graficoVotos = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: etiquetas,
                    datasets: [{
                        data: valores,
                        backgroundColor: ['#0d6efd', '#dc3545', '#ffc107', '#198754', '#0dcaf0', '#6610f2'],
                        hoverOffset: 20
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12 } }
                    }
                }
            });
        }
    </script>
}